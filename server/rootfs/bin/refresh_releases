#!/bin/sh
set -e

TARGET_FILE="${1-/tmp/releases.json}"
RELEASES_BASE_URL='https://api.github.com/repos/Doridian/DarkSignsOnline/releases/'

releases_tmp="$(mktemp)"
chmod 644 "${releases_tmp}"

get_release() {
    track="${1}"
    url="${RELEASES_BASE_URL}${2}"
    suffix="${3-,}"

    echo "Fetching release from ${url}"

    response="$(curl -fsL \
                -H 'Accept: application/vnd.github+json' \
                -H 'X-GitHub-Api-Version: 2022-11-28' \
                "${url}" || exit 1)"

    echo "\"${track}\": ${response}${suffix}" >> "${releases_tmp}"
}

get_release_last() {
    get_release "${1}" "${2}" ''
}

echo '{' > "${releases_tmp}"
get_release 'stable' 'latest' # versioned release
get_release_last 'nightly' 'tags/latest' # nightly
echo '}' >> "${releases_tmp}"

jq . "${releases_tmp}" >/dev/null # Validate JSON

echo 'Releases downloaded OK'

mv "${releases_tmp}" "${TARGET_FILE}"
